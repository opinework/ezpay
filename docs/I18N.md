# EzPay 国际化 (i18n) 指南

本文档介绍 EzPay 的多语言支持功能。

## 支持的语言

| 代码 | 语言 | 文字方向 |
|------|------|----------|
| `en` | English | LTR (从左到右) |
| `zh-CN` | 简体中文 | LTR |
| `zh-TW` | 繁體中文 | LTR |
| `ru` | Русский (俄语) | LTR |
| `fa` | فارسی (波斯语) | RTL (从右到左) |

## 语言切换

### 用户界面

所有页面右上角都有语言选择器，用户可以随时切换语言：

- **收银台** - 支付页面顶部
- **管理后台** - 登录页面和主界面头部
- **商户后台** - 登录页面和侧边栏底部

### URL 参数

可以通过 URL 参数指定语言：

```
http://localhost:6088/cashier/xxx?lang=en
http://localhost:6088/admin?lang=ru
http://localhost:6088/merchant?lang=fa
```

### 语言优先级

系统按以下顺序确定用户语言：

1. URL 参数 (`?lang=xx`)
2. localStorage 存储 (`ezpay_locale`)
3. 浏览器语言设置
4. 默认语言 (zh-CN)

## 文件结构

```
web/static/
├── js/
│   └── i18n.js              # 国际化核心库
├── css/
│   └── i18n.css             # RTL 和语言选择器样式
└── locales/
    ├── en.json              # 英文翻译
    ├── zh-CN.json           # 简体中文翻译
    ├── zh-TW.json           # 繁体中文翻译
    ├── ru.json              # 俄语翻译
    └── fa.json              # 波斯语翻译
```

## 翻译文件格式

翻译文件采用 JSON 格式，支持嵌套结构：

```json
{
  "common": {
    "appName": "EzPay",
    "loading": "Loading...",
    "confirm": "Confirm",
    "cancel": "Cancel"
  },
  "auth": {
    "login": "Login",
    "logout": "Logout",
    "username": "Username",
    "password": "Password"
  },
  "cashier": {
    "title": "Payment",
    "paymentSuccess": "Payment Successful",
    "tips": {
      "crypto": {
        "network": "Please make sure the transfer network is",
        "amount": "Please transfer the exact amount"
      }
    }
  }
}
```

## 开发者指南

### HTML 中使用

使用 `data-i18n` 属性标记需要翻译的元素：

```html
<!-- 文本内容 -->
<span data-i18n="auth.login">登录</span>

<!-- 输入框占位符 -->
<input data-i18n-placeholder="auth.username" placeholder="用户名">

<!-- 元素标题 -->
<button data-i18n-title="common.save" title="保存">💾</button>

<!-- 页面标题 -->
<title data-i18n-document-title="admin.title">管理后台</title>
```

### JavaScript 中使用

```javascript
// 获取翻译文本
const text = $t('auth.login');

// 带参数的翻译
const greeting = $t('common.welcome', { name: 'John' });
// 翻译文件: "welcome": "Welcome, {name}!"
// 结果: "Welcome, John!"

// 检查当前语言
const locale = I18n.locale;  // "zh-CN"

// 切换语言
I18n.setLocale('en');

// 获取支持的语言列表
const locales = I18n.getSupportedLocales();
```

### 初始化

页面加载时初始化国际化：

```html
<script src="/static/js/i18n.js"></script>
<script>
    I18n.init().then(() => {
        // 创建语言选择器
        I18n.createLanguageSelector('langSelector', 'light');
    });

    // 监听语言变化
    window.addEventListener('localeChanged', function(e) {
        console.log('Language changed to:', e.detail.locale);
        // 更新动态内容
    });
</script>
```

### 语言选择器样式

```javascript
// 亮色主题 (用于浅色背景)
I18n.createLanguageSelector('container', 'light');

// 暗色主题 (用于深色背景)
I18n.createLanguageSelector('container', 'dark');

// 紧凑模式 (只显示图标)
I18n.createLanguageSelector('container', 'compact');

// 组合使用
I18n.createLanguageSelector('container', 'compact light');
```

## RTL 支持

波斯语 (fa) 是从右到左 (RTL) 书写的语言。系统自动处理：

- 文字方向切换
- 布局镜像 (侧边栏、表格等)
- 图标位置调整

### CSS RTL 规则

```css
/* 自动应用于 RTL 语言 */
[dir="rtl"] .sidebar {
    left: auto;
    right: 0;
}

[dir="rtl"] .main-content {
    margin-left: 0;
    margin-right: 240px;
}

/* 数字和地址保持 LTR */
[dir="rtl"] .address,
[dir="rtl"] .countdown-time {
    direction: ltr;
}
```

## 添加新语言

### 1. 创建翻译文件

复制 `en.json` 作为模板：

```bash
cp web/static/locales/en.json web/static/locales/xx.json
```

### 2. 翻译内容

编辑新文件，翻译所有文本。

### 3. 注册语言

在 `web/static/js/i18n.js` 中添加：

```javascript
supportedLocales: {
    // ... 现有语言
    'xx': { name: '新语言名称', dir: 'ltr' }  // 或 'rtl'
}
```

### 4. 重新编译

```bash
./build-all.sh
```

## 翻译键命名规范

| 前缀 | 用途 | 示例 |
|------|------|------|
| `common.*` | 通用文本 | common.save, common.cancel |
| `auth.*` | 认证相关 | auth.login, auth.password |
| `admin.*` | 管理后台 | admin.dashboard, admin.settings |
| `merchant.*` | 商户后台 | merchant.profile, merchant.orders |
| `cashier.*` | 收银台 | cashier.paymentSuccess |
| `order.*` | 订单相关 | order.status, order.amount |
| `wallet.*` | 钱包相关 | wallet.address, wallet.chain |
| `withdrawal.*` | 提现相关 | withdrawal.amount, withdrawal.fee |
| `chain.*` | 链监控 | chain.running, chain.stopped |
| `settings.*` | 系统设置 | settings.telegram, settings.rateMode |
| `error.*` | 错误信息 | error.notFound, error.networkError |
| `success.*` | 成功信息 | success.title, success.message |

## 已翻译页面

| 页面 | 翻译程度 | 说明 |
|------|----------|------|
| 收银台 (cashier.html) | 完整 | 所有文本已翻译 |
| 错误页面 (error.html) | 完整 | 按钮已翻译 |
| 成功页面 (success.html) | 完整 | 所有文本已翻译 |
| 管理后台 (admin.html) | 框架 | 菜单、登录、标题已翻译 |
| 商户后台 (merchant.html) | 框架 | 菜单、登录已翻译 |

> 管理后台和商户后台的详细内容翻译可根据需要逐步添加。

## 常见问题

### Q: 为什么某些文本没有翻译？

A: 检查以下几点：
1. 元素是否有 `data-i18n` 属性
2. 翻译键是否存在于语言文件中
3. 浏览器控制台是否有警告信息

### Q: 如何调试翻译？

A: 打开浏览器控制台，缺失的翻译会显示警告：
```
Missing translation: some.missing.key
```

### Q: RTL 布局异常怎么办？

A: 检查 CSS 是否正确使用了 `[dir="rtl"]` 选择器，某些元素（如地址、数字）应保持 LTR。

### Q: 翻译文件更新后不生效？

A:
- 开发模式：刷新浏览器即可
- 生产模式：需要重新编译 (`./build-all.sh`)，因为语言文件嵌入在二进制中
