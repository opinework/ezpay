# EzPay 用户手册

本手册介绍 EzPay 的日常使用，包括管理员后台和商户后台的操作指南。

## 目录

- [管理员后台](#管理员后台)
  - [登录](#登录)
  - [仪表盘](#仪表盘)
  - [商户管理](#商户管理)
  - [钱包管理](#钱包管理)
  - [订单管理](#订单管理)
  - [提现管理](#提现管理)
  - [系统设置](#系统设置)
  - [APP版本管理](#app版本管理)
- [商户后台](#商户后台)
  - [商户登录](#商户登录)
  - [商户仪表盘](#商户仪表盘)
  - [我的订单](#我的订单)
  - [钱包管理](#商户钱包管理)
  - [提现管理](#商户提现管理)
  - [监控APP配置](#监控app配置)
  - [API接入](#api接入)
- [收银台](#收银台)
- [常见问题](#常见问题)

---

## 管理员后台

### 登录

访问地址：`http://your-domain/admin`

默认账号：
- 用户名：`admin`
- 密码：`admin123`

> 首次登录后请立即修改密码！

### 仪表盘

仪表盘展示系统核心数据：

| 指标 | 说明 |
|-----|------|
| 今日订单 | 今日创建的订单总数 |
| 今日成交 | 今日支付成功的订单数 |
| 今日金额 | 今日成交总金额 (CNY) |
| 待处理提现 | 等待审核的提现申请数 |

**趋势图**：展示近7天/30天的订单和金额趋势。

**排行榜**：展示商户成交金额排行。

### 商户管理

#### 创建商户

1. 点击"添加商户"
2. 填写商户信息：
   - 商户名称：商户的显示名称
   - 商户ID (PID)：商户登录和API调用的唯一标识
   - 密码：商户后台登录密码
   - 状态：启用/禁用
3. 点击"保存"

#### 商户设置

| 设置项 | 说明 |
|-------|------|
| 钱包模式 | system (仅系统钱包) / personal (仅个人钱包) / mixed (混合，优先个人) |
| 钱包上限 | 商户可添加的个人钱包数量限制，0表示不限 |
| IP白名单 | API调用IP限制，每行一个IP |
| Referer白名单 | 允许的来源域名 |

#### 查看密钥

点击商户列表中的"查看密钥"可以查看商户的 API Key，用于接口签名。

#### 重置密钥

点击"重置密钥"可以生成新的 API Key。

> 重置后旧密钥立即失效，商户需要更新接入代码。

#### 余额调整

点击"调整余额"可以手动增加或扣减商户余额。

### 钱包管理

#### 加密货币钱包

添加 USDT/TRX 收款地址：

1. 点击"添加钱包"
2. 选择链类型：
   - TRC20 (Tron)
   - BEP20 (BSC)
   - ERC20 (Ethereum)
   - Polygon
   - Optimism
   - Arbitrum
   - Base
   - TRX (Tron 原生币)
3. 输入钱包地址
4. 设置备注标签
5. 点击"保存"

#### 法币收款码

上传微信/支付宝收款码：

1. 点击"添加钱包"
2. 选择类型：微信/支付宝
3. 上传收款码图片
4. 系统自动识别二维码内容
5. 点击"保存"

**支持的二维码格式：**

| 类型 | 格式 |
|-----|------|
| 微信 | wxp://、weixin://、wechatpay.cn |
| 支付宝 | alipay://、qr.alipay.com |

#### 钱包轮询

同一链类型的多个钱包会自动轮询使用，实现负载均衡。

### 订单管理

#### 订单列表

支持筛选条件：
- 商户
- 订单状态：全部/待支付/已支付/已过期/已取消
- 支付类型
- 日期范围
- 订单号/商户订单号

#### 订单状态

| 状态 | 说明 |
|-----|------|
| 待支付 | 订单已创建，等待付款 |
| 已支付 | 已收到付款，回调成功 |
| 已过期 | 超时未付款 |
| 已取消 | 手动取消 |

#### 手动操作

| 操作 | 说明 |
|-----|------|
| 标记已支付 | 手动确认订单已收款 (谨慎使用) |
| 重试回调 | 重新向商户发送支付通知 |
| 查看详情 | 查看订单完整信息 |

#### 订单导出

点击"导出"可以导出当前筛选条件下的订单为 CSV 文件。

#### 清理无效订单

点击"清理无效订单"可以删除超过24小时的未支付订单。

### 提现管理

#### 提现审核

商户提交提现申请后，管理员需要审核：

1. 查看提现详情：金额、手续费、到账金额、收款地址
2. 审核操作：
   - **通过**：同意提现，等待打款
   - **拒绝**：拒绝提现，余额返还

#### 完成打款

审核通过后，手动打款完成后点击"完成打款"确认。

#### 提现地址审核

商户添加的提现地址需要管理员审核后才能使用。

### 系统设置

#### 基础设置

| 设置项 | 说明 |
|-------|------|
| 服务器地址 | 系统对外访问的URL，用于生成回调地址 |
| 订单过期时间 | 订单超时时间（分钟），默认30 |

#### 汇率设置

| 设置项 | 说明 |
|-------|------|
| 汇率模式 | auto(自动)/manual(手动)/hybrid(混合)，仅对USDT生效 |
| 手动汇率 | USDT/CNY 汇率 |
| 汇率浮动 | 在自动汇率基础上的浮动百分比 |

> TRX 汇率始终使用自动模式，从 Binance API 实时获取。

#### 手续费设置

| 设置项 | 说明 |
|-------|------|
| 系统钱包手续费率 | 使用系统钱包时的费率，如0.02=2% |
| 个人钱包手续费率 | 使用商户钱包时的费率 |

#### 链路管理

启用/禁用支付通道：

- 加密货币：TRC20、BEP20、ERC20、Polygon等
- 法币：微信、支付宝

#### Telegram 设置

在系统设置中添加以下配置：

| 配置键 | 说明 |
|-------|------|
| telegram_enabled | 是否启用 (true/false) |
| telegram_bot_token | 从 @BotFather 获取的 Bot Token |

启用后商户可在 Telegram 中与 Bot 对话绑定账号接收通知。

### APP版本管理

管理监控APP版本，供商户下载：

#### 上传新版本

1. 点击"上传新版本"
2. 填写版本信息：
   - 版本号 (Version Code)：数字递增，如 1, 2, 3
   - 版本名 (Version Name)：显示名称，如 1.0.0
   - 更新日志：版本更新内容
   - 强制更新：是否强制用户更新
3. 选择 APK 文件上传
4. 点击"上传"

#### 版本管理

- 启用/禁用版本
- 设置强制更新
- 删除旧版本

---

## 商户后台

### 商户登录

访问地址：`http://your-domain/merchant`

使用管理员分配的商户ID和密码登录。

### 商户仪表盘

展示商户自身数据：
- 今日订单/成交数
- 今日/本月成交金额
- 账户余额
- 近期趋势图

### 我的订单

查看商户自己的订单列表，支持筛选和搜索。

### 商户钱包管理

#### 钱包模式

根据管理员设置，商户可能看到不同的钱包模式：

| 模式 | 说明 |
|-----|------|
| 仅系统钱包 | 使用平台提供的收款地址 |
| 仅个人钱包 | 必须添加自己的收款地址 |
| 混合模式 | 优先使用个人钱包，无可用时使用系统钱包 |

#### 添加个人钱包

1. 点击"添加钱包"
2. 选择类型
3. 输入地址或上传收款码
4. 保存

> 个人钱包数量可能有限制，由管理员设置。

### 商户提现管理

#### 添加提现地址

1. 进入"提现地址"管理
2. 添加收款地址（需管理员审核）
3. 审核通过后可用于提现

#### 申请提现

1. 点击"申请提现"
2. 选择提现地址
3. 输入提现金额
4. 确认手续费和到账金额
5. 提交申请

提现流程：申请 → 管理员审核 → 打款 → 完成

### 监控APP配置

用于配置 V免签 兼容的监控APP：

1. 进入"监控客户端"页面
2. 使用APP扫描二维码
3. APP自动配置服务器地址和密钥

**下载APP**：如果管理员上传了APP，此页面会显示下载按钮。

### API接入

#### 获取密钥

1. 进入"API密钥"页面
2. 查看商户ID (PID) 和密钥 (Key)
3. 如需重置密钥，点击"重置密钥"

#### 接入文档

详见 [API.md](./API.md)

**彩虹易支付兼容接口：**
- 发起支付：`/submit.php` 或 `/api/submit`
- API支付：`/mapi.php` 或 `/api/mapi`
- 查询订单：`/api.php` 或 `/api/query`

**V免签兼容接口：**
- 创建订单：`/createOrder`
- 查询订单：`/getState`
- 关闭订单：`/closeOrder`

---

## 收银台

收银台是用户支付的页面，地址格式：`http://your-domain/cashier/{trade_no}`

### 支付流程

1. 用户访问收银台
2. 选择支付方式（如果有多种）
3. 查看收款地址/二维码和金额
4. 完成支付
5. 系统自动检测到账，跳转到成功页面

### 支付方式

| 类型 | 支付方式 |
|-----|---------|
| 加密货币 | 复制地址转账，或扫描二维码 |
| 微信/支付宝 | 扫描收款码支付 |

### 金额说明

- **应付金额**：显示需要支付的精确金额
- 加密货币显示 USDT/TRX 金额 (6位小数)
- 法币显示人民币金额

> 请务必按显示金额精确支付，否则可能无法自动匹配订单。

---

## 常见问题

### 1. 订单支付后未到账

**可能原因：**
- 付款金额与订单金额不完全一致
- 区块确认数不足，请等待
- 链路监控未启用

**解决方法：**
- 检查交易是否已确认
- 联系管理员手动确认

### 2. 二维码无法识别

**可能原因：**
- 图片模糊或损坏
- 非标准的收款码格式

**解决方法：**
- 使用清晰的原图
- 确保是个人收款码而非商户收款码

### 3. 商户回调失败

**可能原因：**
- 商户服务器无法访问
- 回调地址返回非 "success"
- 签名验证失败

**解决方法：**
- 检查 notify_url 是否可访问
- 确保返回纯文本 "success"
- 核对签名算法

### 4. 汇率不准确

**解决方法：**
- USDT：在系统设置中切换汇率模式 (auto/manual/hybrid)
- TRX：强制使用自动模式，无法手动设置
- 检查网络是否可访问 Binance/OKX API

### 5. 提现地址审核中

提现地址需要管理员审核通过后才能使用，请联系管理员处理。

### 6. 如何绑定 Telegram 通知

1. 在 Telegram 搜索系统机器人
2. 发送 `/start`
3. 发送 `/bind <商户PID> <商户密钥>`
4. 绑定成功后会收到确认消息

---

## 联系支持

如有问题，请联系系统管理员。
